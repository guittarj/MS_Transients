---
title: Species distributions are constrained by seedling emergence, not establishment, in a montane grassland
author: John Guittar, Deborah Goldberg, Kari Klanderud, Astrid Berge, Marta Boixaderes,
  Eric Meineri, Joachim Topper, and Vigdis Vandvik.
output:
  pdf_document:
    fig_caption: no
  word_document: default
  html_document:
    df_print: paged
header-includes: |
  \usepackage{fancyhdr}
  \fancyfoot[LE,RO]{\thepage}
---

\begin{center}
\bigskip
\bigskip
{\Huge Tables and Figures}
\end{center}

\pagebreak

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```


```{r assemble data, include = FALSE}

# set wd
wd <- 'C:\\Users\\John\\Documents\\michigan\\seedclim\\'
setwd(wd)

# load packages
source("MS_Transients\\custom_functions_transients.R")
loadpax(pkg = c('grid','knitr','vegan','lme4','tidyverse','gridExtra','kableExtra','ggpubr','lubridate'))

# load abundance data
x1 <- read.csv("data\\transitions_PersistentSppOccurOnce.csv", stringsAsFactors = FALSE)
x2 <- read.csv("data\\transitions_PersistentSppOccurTwice.csv", stringsAsFactors = FALSE)
x3 <- read.csv("data\\transitions_PersistentSppOccurThrice.csv", stringsAsFactors = FALSE)
x4 <- read.csv("data\\transitions_PersistentSppOccurAlways.csv", stringsAsFactors = FALSE)

# load site metadata
site.meta <- read.csv("data\\site_meta.csv", stringsAsFactors = FALSE)

#load site climate data
clim <- readRDS('data\\site_climates.RDS') %>%
  left_join(site.meta[, c('site','temp.level','precip.level')], by = "site")
  
# Load species 'dictionary'.
dict <- read.csv("data processing\\SpeciesCodeDictionary.csv", stringsAsFactors = FALSE)

#Load trait data
trait.data <- read.csv(file = 'data\\transients_traits.csv', stringsAsFactors = FALSE)

# seed bank data was sampled at a greater area than seedling and seed rain data... so...
# here I randomly subsample the seed bank data (without replacement) down to the fraction (based on area)
# equal to what it should be
frac <- (4 * 0.25^2) / (0.64^2)
x1 <- subbank(x1, frac)
x2 <- subbank(x2, frac)
x3 <- subbank(x3, frac)
x4 <- subbank(x4, frac)

# Create a version of data where seed rain and seed bank are merged into one 'seed' category
xS_sp1 <- mergeseeds(x1)
xS_sp2 <- mergeseeds(x2)
xS_sp3 <- mergeseeds(x3)
xS_sp4 <- mergeseeds(x4)

# create versions with and without unidentified 'sp' individuals
# i do this now because it is easy to forget later...
# and in some cases I want to know the total density of seedlings
xS1 <- filter(xS_sp1, sp != 'sp')
xS2 <- filter(xS_sp2, sp != 'sp')
xS3 <- filter(xS_sp3, sp != 'sp')
xS4 <- filter(xS_sp4, sp != 'sp')
all_cutoffs <- bind_rows(
  mutate(xS1, group = '1/4 local occurrences'),
  mutate(xS2, group = '2/4 local occurrences'),
  mutate(xS3, group = '3/4 local occurrences'),
  mutate(xS4, group = '4/4 local occurrences'))
  
#for all main analyses we will use x3 (persistent = 3 or more occurences)
x_sp <- x3
x <- filter(x3, sp != 'sp')
xS_sp <- xS_sp3
xS <- xS3

# default ggplot theme for later use
th <- theme_bw() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank()) 

# calculate putative climate origins
if (TRUE) {
  x_origins <- add_origins(x, 'categorical')
  xS_origins <- add_origins(xS, 'categorical')
  write.csv(x_origins, "data\\transitions_origins_categorical.csv", row.names = FALSE)
  write.csv(xS_origins, "data\\transitions_seed_origins_categorical.csv", row.names = FALSE)
}

x_origins <- read.csv("data\\transitions_origins_categorical.csv", stringsAsFactors = FALSE)
xS_origins <- read.csv("data\\transitions_seed_origins_categorical.csv", stringsAsFactors = FALSE)

image_dir <- 'C:\\Users\\John\\Documents\\michigan\\seedclim\\MS_Transients\\images\\'

```


\pagebreak


```{r veg coverage, fig.width = 6, fig.height = 3.5}

### testing how well sampled site vegetation is...
tmp_cover <- read.csv(paste0(wd,'data\\cover_all.csv'), header = TRUE, row.names = 1)
tmp_cover.meta <- read.csv(paste0(wd, 'data\\covermeta.csv'), header = TRUE) %>%
  mutate(id = paste(turfID, Year, sep = '_'))

j <- tmp_cover %>%
  mutate(id = row.names(tmp_cover)) %>%
  gather(sp, abun, -id) %>%
  left_join(tmp_cover.meta[, c('id','siteID','TTtreat','Year')], by = 'id') %>%
  filter(!is.na(id) & TTtreat %in% c('TTC','TT1')) %>%
  mutate(site = substring(siteID, 1, 3)) %>%
  filter(abun > 0) %>%
  mutate(turf = gsub('_.*', '', id), id = NULL) %>%
  left_join(x[, c('site','sp', 'id')], by = c("sp", "site")) %>%
  filter(!is.na(id)) %>%
  mutate(id = ifelse(id == 'Persistent', 'Locally persistent species', 'Locally transient species'))

rarefun <- function(df) {
  
  df_tmp <- df %>% 
    mutate(Year = Year - 2009) %>%
    group_by(id, site) %>% 
    mutate(Year = as.numeric(factor(as.character(Year), levels = sample(unique(as.character(Year)))))) %>%
    arrange(id, Year, sp) %>% 
    mutate(
      spp = as.numeric(factor(sp, levels = unique(sp))),
      spp = cummax(spp)) %>%
    group_by(id, site, Year) %>%
    summarise(spp = max(spp))
  
  return(df_tmp)
}


df_all <- list()
for (i in 1:100) {
  df_all[[i]] <- rarefun(j)
}

tmp1 <- bind_rows(df_all) %>%
  group_by(id, site, Year) %>%
  summarise(sd = sd(spp), spp = mean(spp)) %>%
  left_join(site.meta, by = 'site') %>%
  mutate(MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)))

rarefun <- function(df) {
  
  df_tmp <- df %>% 
    group_by(site) %>%
    mutate(turf = as.numeric(factor(turf, levels = sample(unique(turf))))) %>%
    group_by(site, id) %>%
    arrange(id, turf, sp) %>% 
    mutate(spp = as.numeric(factor(sp, levels = unique(sp)))) %>%
    select(-sp, -TTtreat, -Year, -abun, -siteID) %>%
    ungroup() %>%
    complete(site, turf, id, fill = list(spp = 0)) %>%
    group_by(site, id) %>%
    arrange(id, turf, spp) %>% 
    mutate(spp = cummax(spp)) %>%
    group_by(id, site, turf) %>%
    summarise(spp = max(spp))
  
  return(df_tmp)
}


df_all <- list()
for (i in 1:100) {
  df_all[[i]] <- rarefun(j)
}

tmp2 <- bind_rows(df_all) %>%
  group_by(id, site, turf) %>%
  summarise(sd = sd(spp), spp = mean(spp)) %>%
  left_join(site.meta, by = 'site') %>%
  mutate(MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)),
         MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))], levels = c(650,1300,2000,2900))) %>%
  filter(!(site == 'Ram' & turf == 10))

p <- ggplot(tmp2, aes(x = turf, y = spp, color = MAP)) + 
  geom_point(aes(shape = MST, fill = MAP)) +
  geom_line(aes(group = site)) +
  scale_x_continuous(breaks = seq_along(1:10)) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_shape_manual(values = c(24,21,25)) +
  expand_limits(y = 0) +
  facet_wrap(~id) + 
  labs(y = 'Number of species observed', x = 'Number of plots surveyed') +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.position = 'none')

plot_it(p, name = 'VegRarefaction', dir = image_dir, width = 6, height = 3.5)

figS1 <- j %>% 
  group_by(site, sp, id) %>% 
  summarise(abun = sum(abun)) %>% 
  group_by(site) %>% 
  mutate(abun = abun / sum(abun)) %>% 
  ggplot(aes(x = abun, fill = id)) + 
    geom_histogram(position = 'dodge', bins = 50, alpha = 0.7) + 
    scale_y_sqrt(breaks = c(10,50,100)) + 
    scale_x_sqrt(breaks = c(0.01,0.1,0.2,0.3,0.4)) + 
    labs(x = 'Relative abundance at site', y = 'Number of site-level populations') + 
    scale_fill_manual(values = c('black','red'), name = '') +
    geom_hline(yintercept = 0) +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      legend.position = 'bottom')



```


```{r Seed origins, fig.width = 7, fig.height = 4}

# individuals and species status bar plot
tmp <- x %>%
  filter(stage != 'mature') %>%
  mutate(stage = stage_labels(stage)) %>%
  group_by(stage, id) %>%
  summarise(abun = sum(abun)) %>%
  group_by(stage) %>%
  mutate(
    abun_total = sum(abun),
    abun_label = round(100 * sum(abun[id == 'Transient']) / sum(abun)),
    abun_label = paste0(abun_label, '%'),
    id = ifelse(id == 'Transient', 'Locally transient', 'Locally persistent'),
    id = factor(id, levels = c('Locally transient','Locally persistent'))) %>%
  ungroup() %>%
  arrange(desc(id)) %>%
  mutate(group = ifelse(stage %in% c('Seed rain', 'Seed bank'), 'Seeds', 'Seedlings'),
         group = factor(group, levels = c('Seeds','Seedlings'), labels = c('Seeds','Seedlings')))

p <- ggplot(tmp, aes(x = stage, y = abun, fill = id, group = stage)) + 
    geom_bar(stat = 'identity', color = 'black') +
    geom_bar(aes(y = abun*1.1), stat = 'identity', alpha = 0) +
    geom_label(aes(label = abun_label, y = abun_total), vjust = -0.3, show.legend = FALSE) +
    labs(x = '', y = 'Individuals recorded') +
    scale_fill_manual(values = c('grey70','grey90'), name = '', breaks = c("Locally persistent", "Locally transient")) +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.position = 'bottom') +
  facet_wrap(~group, scales = 'free')

p

plot_it(p, name = 'TPnums', dir = image_dir, width = 6, height = 5)


```


```{r individuals vs temp, fig.height = 3.5, fig.width = 7}

j <- x %>%
  filter(stage %in% c('rain','bank')) %>%
  mutate(den = abun / (4 * 0.25^2)) %>%
  group_by(stage, site) %>%
  summarise(
    abun_tran = sum(den[id == 'Transient']),
    abun_per = 100 * abun_tran / sum(den),
    rich_tran = length(unique(sp[id == 'Transient'])),
    rich_per = 100 * rich_tran / length(unique(sp))
  ) %>%
  gather(var, val, -stage, -site) %>%
  left_join(site.meta[, c('site','temp','precip','temp.level','precip.level')], by = 'site') %>%
  ungroup() %>%
  mutate(
    MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))]),
    MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))]),
    stage = stage_labels(stage))

st <- j %>%
  group_by(stage, var) %>%
  do(mod = summary(lm(val ~ temp, data = .))$coef) %>%
  mutate(pval = mod[[2,4]])

j$pval <- st$pval[match(paste(j$stage, j$var), paste(st$stage, st$var))]
j$pval_line <- ifelse(j$pval < 0.1, j$val, NA)
j$pval_line_lty <- factor(ifelse(j$pval < 0.05, 1, 2))

#somtime may need to uselabeller = "label_parsed" to fix superscript

tmp <- j %>%
  filter(stage %in% c('Seed rain','Seed bank')) %>%
  mutate(var = factor(var, levels = c("abun_tran","abun_per","rich_tran","rich_per"),
              labels = c("Transient seeds / m^2",
                         "% Transient seeds\nof site total",
                         "Transient species",
                         "% Transient species\nof site total")))

j1 <- filter(tmp, var %in% c("Transient seeds / m^2", "% Transient seeds\nof site total"))
  
p1 <- ggplot(j1, aes(x = temp, y = val)) +
  geom_point(aes(shape = MST, color = MAP, fill = MAP), size = 3) +
  geom_point(aes(x = temp*1.02, y = val*1.05), alpha = 0) +
  geom_point(x = 0, y = -35, alpha = 0) +
  stat_smooth(aes(y = pval_line), lty = 2, method = 'lm', se = FALSE, color = 'black', data = filter(j1, !is.na(pval_line))) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_shape_manual(values = c(24,21,25)) +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.key = element_blank(),
    legend.position = 'none') +
  labs(x = expression('Mean Summer Temperature ('*degree*'C)'), y = "") +
  facet_grid(var~stage, scale = 'free') +
  expand_limits(y = 0)

j2 <- filter(tmp, var %in% c("Transient species","% Transient species\nof site total"))
  
p2 <- ggplot(j2, aes(x = temp, y = val)) +
  geom_point(aes(shape = MST, fill = MAP, color = MAP), size = 3) +
  geom_point(aes(x = temp*1.02, y = val*1.05), alpha = 0) +
  geom_point(x = 0, y = -35, alpha = 0) +
  stat_smooth(aes(y = pval_line, lty = pval_line_lty), color = 'black', method = 'lm', se = FALSE, data = filter(j2, !is.na(pval_line))) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_shape_manual(values = c(24,21,25)) +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.key = element_blank(),
    legend.position = 'none') +
  guides(linetype = FALSE) +
  labs(x = expression('Mean Summer Temperature ('*degree*'C)'), y = "") +
  facet_grid(var~stage, scale = 'free') +
  expand_limits(y = 0)

p <- ggarrange(p1, p2, ncol=2)

plot_it(p, name = 'tranTrends', dir = image_dir, width = 7, height = 3.5)


```


```{r composition of transients, fig.width = 5, fig.height = 6}

tmp <- x_origins %>%
  filter(stage != 'mature' & id != 'Persistent') %>%
  mutate(stage = stage_labels(stage)) %>%
  group_by(stage) %>%
  mutate(abun_total = sum(abun)) %>%
  group_by(stage, id = idT) %>%
  summarise(origin = sum(abun) / unique(abun_total)) %>%
  ungroup() %>%
  mutate(id = ifelse(id == 'Same temperature', 'Same Temp.', id)) %>%
  mutate(id = factor(id, levels = c('Unknown','Cooler','Same Temp.','Warmer')))

fig4_1 <- ggplot(tmp, aes(x = stage, y = origin, fill = id)) +
  geom_bar(stat = 'identity', color = 'black') +
  labs(x = '', y = 'Composition of transient species') +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = 'Oranges', name = 'Nearest persistent\nadult population') +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank())

tmp <- x_origins %>%
  filter(stage != 'mature' & id != 'Persistent') %>%
  mutate(stage = stage_labels(stage)) %>%
  group_by(stage) %>%
  mutate(abun_total = sum(abun)) %>%
  group_by(stage, id = idP) %>%
  summarise(origin = sum(abun) / unique(abun_total)) %>%
  ungroup() %>%
  mutate(id = ifelse(id == 'Same precipitation', 'Same Precip.', id)) %>%
  mutate(id = factor(id, levels = c('Unknown','Drier','Same Precip.','Wetter')))

fig4_2 <- ggplot(tmp, aes(x = stage, y = origin, fill = id)) +
  geom_bar(stat = 'identity', color = 'black') +
  labs(x = '', y = 'Composition of transient species') +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = 'Blues', name = 'Nearest persistent\nadult population') +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank())

p <- ggarrange(fig4_1, fig4_2, nrow = 2)

plot_it(p, name = 'originBars', dir = image_dir, width = 5, height = 6)

```


```{r models, include = FALSE}


### GLMs

#Note I originally tried to do a zero-inflated negative binomial but it has ~3x df and has a much higher AIC. Thus zero inflated models aren't a good choice here.

#A good stack overflow post on glm QC: https://stats.stackexchange.com/questions/70558/diagnostic-plots-for-count-regression
# the basic strategy here is to do GLMs at three tiers of resolution: (1) species grouped into transient/persistent; (2) species groupedinto persistent, same temp/precip, different temp/precip; (3) species grouped into persistent, same temp/precip, warmer/drier, cooler/wetter, unknown temp/precip. And then run models with each of those 'id' specifications.
j <- xS_origins %>%
  left_join(site.meta[, c('site','temp','precip')], by = 'site') %>%
  mutate(
    temp = as.numeric(scale(temp, scale = FALSE)), 
    precip = as.numeric(scale(precip, scale = FALSE)),
    idT = factor(idT, levels = c('Local','Same temperature','Cooler','Warmer','Unknown')),
    idP = factor(idP, levels = c('Local','Same precipitation','Drier','Wetter','Unknown'))) %>%
  spread(stage, abun, fill = 0)

#GLM to model species emergence. I convert abundane into a binary (0 or 1)
tmp <- j %>%
  filter(!(seed == 0 & germ == 0)) %>%
  mutate(germ = ifelse(germ > 0, 1, 0))

#null
# climate
#transient, persistent
#persistent, same temp/precip, diff temp/precip
#persistent, same temp/precip, cooler/drier, warmer/wetter, unknown temp precip
germbinNull <-   glm(germ ~ log(seed + 1), data = tmp, family = 'binomial')
germbinClim <-   glm(germ ~ log(seed + 1) + temp + precip, data = tmp, family = 'binomial')
germbinS <-      glm(germ ~ log(seed + 1) + temp * id + precip * id, data = tmp, family = 'binomial')
germbinT <-      glm(germ ~ log(seed + 1) + temp + precip + idT, data = tmp, family = 'binomial')
germbinP <-      glm(germ ~ log(seed + 1) + temp + precip + idP, data = tmp, family = 'binomial')

#calculate how many data points occur for each category, for Table 1
germ_n <- c(table(tmp$idT), table(tmp$idP))[c(1,2,7,3,4,8,9,5)]

# GLM to model individuals germinated
tmp <- filter(j, !(seed == 0 & germ == 0))

germNull <-   MASS::glm.nb(germ ~ log(seed + 1), data = tmp)
germClim <-   MASS::glm.nb(germ ~ log(seed + 1) + temp + precip, data = tmp)
germS <-      MASS::glm.nb(germ ~ log(seed + 1) + temp * id + precip * id, data = tmp)
germT <-      MASS::glm.nb(germ ~ log(seed + 1) + temp + precip + idT, data = tmp)
germP <-      MASS::glm.nb(germ ~ log(seed + 1) + temp + precip + idP, data = tmp)

### GLM to model species establishment  - again, converting abun to binary
tmp <- j %>%
  filter(germ > 0) %>%
  mutate(est = ifelse(est > 0, 1, 0))

estbinNull <-   glm(est ~ log(germ), data = tmp, family = 'binomial')
estbinClim <-   glm(est ~ log(germ) + temp + precip, data = tmp, family = 'binomial')
estbinS <-      glm(est ~ log(germ) + temp * id + precip * id, data = tmp, family = 'binomial')
estbinT <-      glm(est ~ log(germ) + temp + precip  + idT, data = tmp, family = 'binomial')
estbinP <-      glm(est ~ log(germ) + temp + precip  + idP, data = tmp, family = 'binomial')

#calculate how many data points occur for each category, for Table 1
est_n <- c(table(tmp$idT), table(tmp$idP))[c(1,2,7,3,4,8,9,5)]

### GLM to model individuals established
tmp <- filter(j, germ > 0)
estNull <-    MASS::glm.nb(est ~ log(germ), data = tmp)
estClim <-    MASS::glm.nb(est ~ log(germ) + temp + precip, data = tmp)
estS <-      MASS::glm.nb(est ~ log(germ) + temp * id + precip * id, data = tmp)
estT <-      MASS::glm.nb(est ~ log(germ) + temp + precip  + idT, data = tmp)
estP <-      MASS::glm.nb(est ~ log(germ) + temp + precip  + idP, data = tmp)

# store coefficients
coefs <- list()
coefs$germbinNull <- as.data.frame(summary(germbinNull)$coefficients)
coefs$germbinClim <- as.data.frame(summary(germbinClim)$coefficients)
coefs$germbinS <- as.data.frame(summary(germbinS)$coefficients)
coefs$germbinT <- as.data.frame(summary(germbinT)$coefficients)
coefs$germbinP <- as.data.frame(summary(germbinP)$coefficients)
coefs$germNull <- as.data.frame(summary(germNull)$coefficients)
coefs$germClim <- as.data.frame(summary(germClim)$coefficients)
coefs$germS <- as.data.frame(summary(germS)$coefficients)
coefs$germT <- as.data.frame(summary(germT)$coefficients)
coefs$germP <- as.data.frame(summary(germP)$coefficients)
coefs$estbinNull <- as.data.frame(summary(estbinNull)$coefficients)
coefs$estbinClim <- as.data.frame(summary(estbinClim)$coefficients)
coefs$estbinS <- as.data.frame(summary(estbinS)$coefficients)
coefs$estbinT <- as.data.frame(summary(estbinT)$coefficients)
coefs$estbinP <- as.data.frame(summary(estbinP)$coefficients)
coefs$estNull <- as.data.frame(summary(estNull)$coefficients)
coefs$estClim <- as.data.frame(summary(estClim)$coefficients)
coefs$estS <- as.data.frame(summary(estS)$coefficients)
coefs$estT <- as.data.frame(summary(estT)$coefficients)
coefs$estP <- as.data.frame(summary(estP)$coefficients)

if (!'idPWetter' %in% row.names(coefs$estP)) {
  tmp <- coefs$estbinP[1:6, ]
  tmp <- rbind(tmp, rep(NA, 4))
  row.names(tmp)[7] <- 'idPWetter'
  tmp <- rbind(tmp, coefs$estbinP[7, ])
  coefs$estbinP <- tmp
  
  tmp <- coefs$estP[1:6, ]
  tmp <- rbind(tmp, rep(NA, 4))
  row.names(tmp)[7] <- 'idPWetter'
  tmp <- rbind(tmp, coefs$estP[7, ])
  coefs$estP <- tmp
  
}

myvars <- c(
  'log(seed + 1)' = 'Log(seed no.)',
  'log(germ)' = 'Log(seedling no.)',
  'temp' = 'Local temperature', 
  'precip' = 'Local precipitation',
  'idTransient' = 'Transient',
  'temp:idTransient' = 'Transient * Local temperature',
  'idTransient:precip' = 'Transient * Local precipitation',
  'idTSame temperature' = 'Transient from similar temp.',
  'idTCooler' = 'Transient from cooler climate',
  'idTWarmer' = 'Transient from warmer climate',
  'idTUnknown' = 'Transient from unknown climate',
  'idPSame precipitation' = 'Transient from similar precip.',
  'idPDrier' = 'Transient from drier climate',
  'idPWetter' = 'Transient from wetter climate',
  'idPUnknown' = 'Transient from unknown climate'
)

#process coefficients for table 1
mod_coefs <- lapply(coefs, function(x) data.frame(variable = row.names(x), x))
mod_coefs <- do.call(rbind.data.frame, mod_coefs)
mod_coefs$Model <- unlist(lapply(strsplit(row.names(mod_coefs), '\\.'), function(x) x[1]))
mod_coefs <- mod_coefs %>%
  filter(!variable %in% c('(Intercept)')) %>%
  transmute(
    Model, 
    Variable = myvars[match(variable, names(myvars))], 
    Estimate = z.value, 
    p.value = Pr...z..) %>%
  arrange(Model, Variable)

```


```{r transition probabilities, fig.height = 3.5}

j <- xS %>%
  spread(stage, abun, fill = 0) %>%
  mutate(id = ifelse(id == 'Persistent', 'Locally persistent', 'Locally transient'))

# calculate maximums to use for setting data windows
maxtran <- max(filter(j, id == 'Locally transient')$seed)
maxgerm <- max(filter(j, id == 'Locally transient')$germ)

p1 <- j %>%
  filter(seed <= maxtran) %>%
  ggplot(aes(x = seed + 1, y = germ + 1, color = id, fill = id)) +
    geom_abline(slope = 1, lty = 3) +
    geom_point(aes(x = germ + 1, y = seed + 1), alpha = 0) +
    geom_point(alpha = 0.1) +
    stat_smooth(aes(x = jitter(seed + 1)), alpha = 0.5, method = 'loess') +
    scale_color_manual(values = c('black','red')) +
    scale_fill_manual(values = c('black','red')) +
    scale_x_log10(breaks = c(1,10,100,1000)) +
    scale_y_log10(breaks = c(1,10,100,1000)) +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      legend.title = element_blank(),
      legend.position = 'bottom') +
    labs(x = 'Seeds + 1', y = 'Emerged Seedlings + 1')

p2 <- j %>%
  filter(germ > 0) %>%
  filter(germ <= maxgerm) %>%
  ggplot(aes(x = germ + 1, y = est + 1, color = id, fill = id)) +
    geom_point(alpha = 0.1) +
    geom_abline(slope = 1, lty = 3) +
    stat_smooth(method = 'loess') +
    scale_color_manual(values = c('black','red')) +
    scale_fill_manual(values = c('black','red')) +
    scale_x_log10(breaks = c(2,10)) +
    scale_y_log10() +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      legend.position = 'none',
      legend.title = element_blank()
      ) +
    labs(x = 'Emerged seedlings + 1', y = 'Established seedlings + 1')

p <- ggarrange(p1, p2, ncol = 2, common.legend = TRUE, legend = 'bottom')

plot_it(p, name = 'emergeEstab', dir = image_dir, width = 6.5, height = 3.5)

```


```{r transition probabilities all}

j <- all_cutoffs %>%
  spread(stage, abun, fill = 0) %>%
  mutate(id = ifelse(id == 'Persistent', 'Locally persistent', 'Locally transient'))


# calculate maximums to use for setting data windows
j1 <- j %>%
  filter(seed <= max(seed[id == 'Locally transient'])) %>% 
  mutate(transition = 'Emergence')

j2 <- j %>%
  filter(germ > 0) %>%
  group_by(group) %>% 
  filter(germ <= max(germ[id == 'Locally transient'])) %>% 
  mutate(transition = 'Establishment')

p1 <- j1 %>%
  ggplot(aes(color = id, fill = id)) +
    geom_abline(slope = 1, lty = 3) +
    geom_point(aes(x = germ + 1, y = seed + 1), alpha = 0) +
    geom_point(aes(x = seed + 1, y = germ + 1), alpha = 0.1) +
    stat_smooth(aes(x = jitter(seed + 1), y = germ + 1), alpha = 0.5, method = 'loess') +
    scale_color_manual(values = c('black','red')) +
    scale_fill_manual(values = c('black','red')) +
    scale_x_log10() +
    scale_y_log10() +
    facet_wrap(~group, ncol = 4, scales = 'free') +
    theme_bw() +
      theme(
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.background = element_blank(),
        legend.title = element_blank(),
        legend.position = 'bottom') +
      labs(x = 'Seeds + 1', y = 'Emerged Seedlings + 1')

p2 <- j2 %>%
  ggplot(aes(x = germ + 1, y = est + 1, color = id, fill = id)) +
    geom_point(aes(x = est + 1, y = germ + 1), alpha = 0, data = filter(j2, est > 1)) +
    geom_point(alpha = 0.1) +
    geom_abline(slope = 1, lty = 3) +
    stat_smooth(method = 'loess') +
    scale_color_manual(values = c('black','red')) +
    scale_fill_manual(values = c('black','red')) +
    scale_y_log10() +
    scale_x_log10() +
    facet_wrap(~group, ncol = 4, scales = 'free') +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      legend.position = 'none',
      legend.title = element_blank()) +
    labs(x = 'Emerged seedlings + 1', y = 'Established seedlings + 1')

p <- ggarrange(p1, p2, nrow = 2, common.legend = TRUE, legend = 'bottom')

plot_it(p, name = 'emergeEstabAll', dir = image_dir, width = 6.5, height = 4.5)


```

```{r traits by stage biplot, fig.height = 4, fig.width=8}

traits1 <- c(
  leaf.area   = expression('Log Leaf Area ('*mm^2*')'), 
  max.height  = expression('Log Max'~'Height (m)'), 
  seed.mass   = expression('Log'~'Seed'~'Mass'~'(mg)'), 
  sla         = expression('Log SLA ('*m^2*kg^-1*')'),
  buds        = expression('Bud'~'Number'),
  lat         = expression('Lateral'~'Spread'~'(%)'), 
  offs        = expression('Offspring'~'(%)'), 
  conper      = expression('Conn. Persistence'~'(%)')
)

j <- xS %>%
  left_join(trait.data, by = 'sp') %>%
  gather(trait, val, seed.mass, sla, leaf.area, max.height, conper, offs, lat,  buds) %>%
  mutate(trait = factor(traits1[match(trait, names(traits1))], levels = traits1)) %>%
  filter(stage != 'mature') %>%
  group_by(trait) %>%
  mutate(stage = ifelse(stage == 'seed', 'Seed rain + seed bank', stage),
         stage = ifelse(stage == 'germ', 'Emerged seedlings', stage),
         stage = ifelse(stage == 'est', 'Established seedlings', stage),
         stage = factor(stage, levels = c('Seed rain + seed bank', 'Emerged seedlings','Established seedlings'))) %>%
  ungroup() %>%
  group_by(site, stage, trait, id) %>%
  summarise(cm = mean(val, na.rm = T)) %>%
  group_by(site, stage, trait) %>%
  spread(id, cm) %>%
  filter(!is.na(Transient + Persistent)) %>%
  mutate(diff = Persistent - Transient) %>%
  left_join(site.meta, by = c("site"))

mods.lm <- j %>%
  group_by(trait, stage) %>%
  do(mod = summary(lm(diff ~ temp + precip, data = .))) %>%
  mutate(p.temp = mod$coefficients[[12]],
         t.temp = mod$coefficients[[11]],
         mod = NULL)

mods <- j %>%
  group_by(trait, stage) %>%
  do(mod = t.test(.$Transient, .$Persistent, paired = TRUE)) %>%
  mutate(pval = mod$p.value) %>%
  left_join(mods.lm, by = c("trait", "stage"))

j <- j %>%
  left_join(mods[, c('trait','stage','pval')], by = c("trait", "stage")) %>%
  mutate(sig = ifelse(pval < 0.05, '*', NA))

tmp2 <- j %>% 
  ungroup() %>%
  mutate(sig = ifelse(is.na(sig), 'p > 0.05', 'p < 0.05')) %>%
  mutate(MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)),
         MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))], levels = c(650,1300,2000,2900)))

#Our transformation function
scaleFUN <- function(x) sprintf("%.1f", x)

p <- ggplot(filter(tmp2, stage == 'Seed rain + seed bank'), aes(x = Persistent, y = Transient)) +
  geom_abline(slope = 1, lty = 3) +
  geom_point(aes(color = MAP, fill = interaction(sig, MAP), shape = MST), size = 3, alpha = 0.8) +
  geom_point(aes(y = Persistent, x = Transient), alpha = 0) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', 'transparent', '#749ED5', 'transparent', '#5057B2', 'transparent', '#140D8F', 'transparent')) +
  scale_y_continuous(labels = scaleFUN) +
  scale_x_continuous(labels = scaleFUN) +
  scale_shape_manual(values = c(24,21,25)) +
  facet_wrap(~trait, scales = 'free', ncol = 4, labeller = label_parsed) + 
  theme_bw() +
  theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      legend.position = 'none') +
  labs(x = 'Trait mean of locally persistent species', y = 'Trait mean of locally transient species')

plot_it(p, name = 'traitBiplot', dir = image_dir, width = 7, height = 3.75)






```


```{r Table 1 seedling emergence}

j <- mod_coefs %>%
  filter(Model %in% c('germNull','germClim','germS','germP','germT')) %>%
  mutate(Variable = as.character(Variable)) %>%
  complete(Model, Variable) %>%
  mutate(Variable = factor(Variable, levels = myvars[-11])) %>%
  arrange(Model, Variable) %>%
  mutate(
    Estimate = sprintf("%.2f", Estimate),
    Estimate = ifelse(p.value < 0.001, paste0("**", Estimate),
                           ifelse(p.value < 0.05, paste0("*", Estimate), Estimate)),
    p.value = NULL) %>%
  spread(Model, Estimate, fill = NA) %>%
  mutate(
    Variable = as.character(Variable),
    N = c(rep(sum(germ_n[c(1,2,4,5,8)]), 3), rep(sum(germ_n[c(2,4,5,8)]),3), germ_n[c(2,4,5,3,6,7,8)])
    ) %>%
  select(Variable, germNull, germClim, germS, germT, germP)

AICs <- c('$\\Delta$AIC', sprintf("%.2f", c(c(AIC(germNull), AIC(germClim), AIC(germS), AIC(germT), AIC(germP)) - AIC(germNull))))

j <- rbind(AICs, j)

options(knitr.kable.NA = '-')

tmp <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", align = c('l','r','r','r','r','r','r'),
      col.names = linebreak(c("", "Null model", "Site climate", "Site climate +\nSp. status", "Site climate +\n Sp. temp. origin", "Site climate +\nSp. precip. origin"), align = 'r')) %>%
  kable_styling() %>%
  group_rows("General predictors", 2, 4) %>%
  group_rows("Transient/Persistent predictors", 5, 7) %>%
  group_rows("Origin-based predictors", 8, 14) %>%
  footnote(threeparttable = TRUE, general = 'Standardized coefficients (z-scores) from different GLM models (columns) predicting numbers of emerged seedlings by species and site. In column headers (i.e., model descriptions), "Species status" refers to whether the species is locally transient or persistent, and "Species temperature/precipitation origin" refers to the putative climate origin based on the nearest persistent adult population. Data include all recorded seeds and seedlings that could be identified to species. N is equal to the number of unique species-by-site combinations for each category/predictor. Asterisks denote significance (*: p < 0.05, **: p < 0.001). Dashes indicate predictors that were not included in a given model. Including model terms for local transient/persistent species status and then putative temperature and precipitation origins progressively improved model performance, as reflected in the reduction of AIC values relative to the null model that uses only local seed numbers as a predictor.', general_title = "Table 1.", title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tab1'), density = 500)

```


```{r abuns historgram}

figS1

plot_it(figS1, name = 'abunHist', dir = image_dir, width = 6.5, height = 4)


```


```{r site climates}

figClim <- clim %>%
  filter(year < 2014) %>%
  mutate(temp.level = factor(temp.level, 3:1)) %>%
  ggplot(aes(x = MAP * 10, y = MST, fill = factor(year), shape = factor(temp.level))) +
  geom_point(shape = 21, size = 4, alpha = 0.9) + 
  labs(x = "Annual precipitation (mm)", y = expression('Summer Temperature ('*degree*'C)')) +
  facet_grid(temp.level~precip.level) +
  scale_fill_brewer(palette = 'Spectral', name = "") +
  theme_bw() +
  theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank(),
      strip.text = element_blank(),
      legend.position = 'bottom')

plot_it(figClim, name = 'figClim', dir = image_dir, width = 6.5, height = 5.5)

```

```{r seed rarefactions, fig.height = 3.5}

#checking sampling effort in seed rain seed bank
# read seed bank data
tmp <- x %>%
  filter(stage == 'bank') %>%
  group_by(site) %>%
  summarise(Scale = 2498, spp = length(unique(sp)))

bank <- read.csv(paste0(wd, 'data\\seedbank.csv'), strip.white=TRUE,, stringsAsFactors = FALSE) %>%
  group_by(site = Site, Scale) %>% 
  summarise(spp = mean(Nsp)) %>%
#  bind_rows(tmp) %>%
  left_join(site.meta, by = 'site') %>%
  mutate(MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)),
         MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))], levels = c(650,1300,2000,2900)))

p2 <- ggplot(bank, aes(x = Scale, y = spp, fill = MAP)) + 
  geom_point(aes(shape = MST, color = MAP), size = 2) +
  geom_line(aes(group = site, color = MAP)) +
  scale_shape_manual(values = c(24,21,25)) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  expand_limits(y = 0) +
  labs(y = '', x = 'Area surveyed (sq. cm)') +
  ggtitle('Seed bank data') +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.position = 'none')


#read seed rain data
rain <- read.csv(paste0(wd, 'data\\seedrain.csv'), strip.white=TRUE, stringsAsFactors = FALSE) %>% 
  mutate(X.1 = ifelse(X.1 == 'vik', 'Vik', X.1)) %>%
  filter(S.V == 'S') %>% 
  select(-S.V) %>% 
  rename(site = X.1, block = X) %>%
  filter(block != 'block5') %>%
  gather(sp, abun, -site, -block) %>%
  filter(abun > 0)

repfun <- function(df) {
  
  df <- df %>% 
    group_by(site) %>% 
    mutate(block = as.numeric(factor(block, levels = sample(unique(block))))) %>%
    arrange(site, block, sp) %>% 
    mutate(sp = as.numeric(factor(sp, levels = unique(sp))), 
           spp = cummax(sp)) %>%
    arrange(site, block, spp) %>%
    group_by(site, block) %>% 
    summarise(spp = max(spp))
  
  return(df)
}

df_all <- list()
for(i in c(1:100)) {
  df_all[[i]] <- repfun(rain)
}

rain <- bind_rows(df_all) %>%
  group_by(site, block) %>%
  summarise(sd = sd(spp), spp = mean(spp)) %>%
  left_join(site.meta, by = 'site') %>%
  mutate(MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)),
         MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))], levels = c(650,1300,2000,2900)))

p1 <- ggplot(rain, aes(x = block, y = spp, fill = MAP)) + 
  geom_point(aes(shape = MST, color = MAP), size = 2) +
  geom_line(aes(group = site, color = MAP)) +
  scale_x_continuous(breaks = seq_along(1:5)) +
  scale_shape_manual(values = c(24,21,25)) +
  scale_color_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F')) +
  expand_limits(y = 0) +
  labs(y = 'Number of species observed', x = 'Number of 25 x 25 cm plots surveyed') +
  ggtitle('Seed rain data') +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    legend.position = 'none')

p <- ggarrange(p1, p2, ncol=2)

plot_it(p, name = 'seedRares', dir = image_dir, width = 6.5, height = 3.5)

```


```{r transition probabilities with temp levels, fig.height = 4}

j <- xS %>%
  spread(stage, abun, fill = 0) %>%
  mutate(id = ifelse(id == 'Persistent', 'Locally persistent', 'Locally transient'))

# calculate maximums to use for setting data windows
maxseed <- max(filter(j, id == 'Locally transient')$seed)

j1 <- j %>%
  filter(seed <= maxseed) %>%
  left_join(site.meta, by = 'site') %>%
  group_by(temp.level) %>%
  mutate(temp = paste(round(mean(temp), 1), '°C')) %>%
  ungroup() %>%
  mutate(temp = factor(temp, levels = unique(temp)[c(3,1,2)]))

p1 <- ggplot(j1, aes(x = seed + 1, y = germ + 1, color = id, fill = id)) +
    geom_abline(slope = 1, lty = 3) +
    geom_point(aes(x = germ + 1, y = seed + 1), alpha = 0) +
    geom_point(alpha = 0.1) +
    stat_smooth(aes(x = seed + 1, lty = factor(temp)), alpha = 0.5, method = 'lm', se = FALSE) +
    scale_color_manual(values = c('black','red'), name = "") +
    scale_fill_manual(values = c('black','red'), name = "") +
    scale_linetype_discrete(name = '') +
    scale_x_log10(breaks = c(1,10,100,1000)) +
    scale_y_log10(breaks = c(1,10,100,1000)) +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank()) +
    guides(lty = guide_legend(override.aes = list(color = 'black'))) +
    labs(x = 'Seeds + 1', y = 'Emerged Seedlings + 1')


# calculate maximums to use for setting data windows
maxgerm <- max(filter(j, id == 'Locally transient')$germ)

j2 <- j %>%
  filter(germ <= maxgerm) %>%
  left_join(site.meta, by = 'site') %>%
  group_by(temp.level) %>%
  mutate(temp = paste(round(mean(temp), 1), '°C')) %>%
  ungroup() %>%
  mutate(temp = factor(temp, levels = unique(temp)[c(3,1,2)]))

p2 <- ggplot(j2, aes(x = germ + 1, y = est + 1, color = id, fill = id)) +
    geom_abline(slope = 1, lty = 3) +
    geom_point(aes(x = est + 1, y = germ + 1), alpha = 0) +
    geom_point(alpha = 0.1) +
    stat_smooth(aes(x = germ + 1, lty = factor(temp)), alpha = 0.5, method = 'lm', se = FALSE) +
    scale_color_manual(values = c('black','red'), name = "") +
    scale_fill_manual(values = c('black','red'), name = "") +
    scale_linetype_discrete(name = '') +
    scale_x_log10(breaks = c(1,10,100,1000)) +
    scale_y_log10(breaks = c(1,10,100,1000)) +
    theme_bw() +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major = element_blank(),
      panel.background = element_blank()) +
    guides(lty = guide_legend(override.aes = list(color = 'black'))) +
    labs(x = 'Emerged Seedlings + 1', y = 'Established Seedlings + 1')

p <- ggarrange(p1, p2, ncol=2, common.legend = TRUE, legend = 'bottom')

plot_it(p, name = 'statusTemp', dir = image_dir, width = 7, height = 3.5)

```


```{r density and richness table}

# first take average density across blocks
# then sum densities of seed rain and seed bank
# I want to keep sp's here for den measure
j <- rbind(
  x_sp,
  filter(xS_sp, stage == 'seed'),
  filter(x_sp, stage != 'mature') %>% mutate(stage = 'seeds.seedlings'),
  mutate(x_sp, stage = 'all'))

j_den <- j %>%
  filter(!stage %in% c('mature','all')) %>%
  group_by(stage, site) %>%
  mutate(den = abun / (4 * 0.25^2)) %>%
  summarise(den = sum(den)) %>%
  group_by(stage) %>%
  summarise(
    den_sd = sd(c(den, rep(0, 12 - length(den)))), 
    den = mean(c(den, rep(0, 12 - length(den)))))
  
j_den_trans <- j %>%
  filter(id == 'Transient') %>%
  filter(!stage %in% c('mature','all')) %>%
  group_by(stage, site) %>%
  mutate(den = abun / (4 * 0.25^2)) %>%
  summarise(den = sum(den)) %>%
  group_by(stage) %>%
  summarise(
    den_sd = sd(c(den, rep(0, 12 - length(den)))), 
    den = mean(c(den, rep(0, 12 - length(den)))))

j_site_richness <- j %>%
  filter(sp != 'sp') %>%
  group_by(site, stage) %>%
  summarise(rich = length(unique(sp))) %>%
  group_by(stage) %>%
  summarise(
    site_sd = sd(c(rich, rep(0, 12 - length(rich))), na.rm = T), 
    site_rich = mean(c(rich, rep(0, 12 - length(rich)))))

j_site_richness_trans <- j %>%
  filter(sp != 'sp') %>%
  filter(id == 'Transient') %>%
  group_by(site, stage) %>%
  summarise(rich = length(unique(sp))) %>%
  group_by(stage) %>%
  summarise(
    site_sd = sd(c(rich, rep(0, 12 - length(rich))), na.rm = T), 
    site_rich = mean(c(rich, rep(0, 12 - length(rich)))))
  
j_regional_richness <- j %>%
  filter(sp != 'sp') %>%
  group_by(stage) %>%
  summarise(rich = length(unique(sp)))

j_regional_richness_trans <- j %>%
  filter(sp != 'sp') %>%
  filter(id == 'Transient') %>%
  group_by(stage) %>%
  summarise(rich = length(unique(sp)))

j_all <- j_den %>%
  full_join(j_site_richness, by = 'stage') %>%
  full_join(j_regional_richness, by = 'stage')

j_trans <- j_den_trans %>%
  full_join(j_site_richness_trans, by = 'stage') %>%
  full_join(j_regional_richness_trans, by = 'stage')

stages <- c('Seed Rain' = 'rain', 'Seed Bank' = 'bank', 'All Seeds' = 'seed', 'Emerged Seedlings' = 'germ', 'Established Seedlings' = 'est', 'Seeds and Seedlings' = 'seeds.seedlings', 'Adults' = 'mature', 'All Stages' = 'all')

#at some point it would be nice to align this by the plus-minus sign, but currently I can't figure this out. Might need to move to full Latex. I almost had it by adding tildes after the plus-minus sign, but they're not spaced the same as numbers so it looks wonky. Gah!

j <- rbind(mutate(j_all, group = 'all'), 
           mutate(j_trans, group = 'trans')) %>%
  filter(!(group == 'trans' & stage %in% c('mature','all'))) %>%
  transmute(
    group,
    Stage = factor(names(stages)[match(stage, stages)], names(stages)),
    `Density (per sq. m.)` = ifelse(is.na(den), '', paste(round(den), '±', round(den_sd))),
    `Site richness` = paste(round(site_rich), '±', round(site_sd)),
    `Regional richness` = ifelse(group == 'all', rich, NA)) %>%
  arrange(group, Stage)
         
tmp <- j %>% select(-group)

tmp <- kable(tmp, format = 'latex', booktabs = T, escape = F, align = c('l', 'r','r','r')) %>%
    kable_styling() %>%
    row_spec(0, bold = T) %>%
    group_rows("All Individuals", 1, 8) %>%
    group_rows("Transients Only", 9, 14) %>%
    footnote(general = 'Densities and species richness values within and across sites for each life stage. The density of "all individuals"" includes unidentified seeds and seedlings. Regional richness is not shown for locally transient species because transient/persistent species status can vary by site, and thus cannot be summarized in this way across sites.', general_title = "Table S1.", threeparttable = T, title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabS1'), density = 500)

```

\pagebreak

```{r linear model stats table all species}

j <- x %>%
  #filter(stage %in% c('rain','bank')) %>%
  group_by(stage, site) %>%
  mutate(den = abun / (4 * 0.25^2)) %>%
  summarise(
    abun_all = sum(den),
    abun_tran = sum(den[id == 'Transient']),
    rich_all = length(unique(sp)),
    rich_tran = length(unique(sp[id == 'Transient'])),
    abun_tranper = abun_tran / abun_all,
    rich_tranper = rich_tran / rich_all
  ) %>%
  gather(var, val, -stage, -site) %>%
  left_join(site.meta, by = 'site') %>%
  ungroup() %>%
  group_by(stage, var) %>%
  do(mod = summary(lm(val ~ scale(temp, scale = FALSE) + scale(precip, scale = FALSE), data = .))) %>%
  mutate(r2 = mod$r.squared)

tmp <- lapply(j$mod, coefficients)
names(tmp) <- paste(j$stage, j$var, sep = ';')
j <- reshape2::melt(tmp)
j$Var2 <- as.character(j$Var2)
j$Var2[j$Var2 == 'Pr(>|t|)'] <- 'pval'  
j$Var2[j$Var2 == 't value'] <- 'tval'
j$Var2[j$Var2 == 'Std. Error'] <- 'se'
j <- j %>%
  spread(Var2, value) %>%
  separate(L1, sep = ';', into = c('stage', 'var')) %>%
  separate(var, sep = '_', into = c('var', 'group')) %>%
  filter(as.character(Var1) != '(Intercept)') %>%
  mutate(
    Stage = stage_labels(stage),
    Predictor = factor(c('Temperature','Precipitation')[match(Var1, 
      c('scale(temp, scale = FALSE)','scale(precip, scale = FALSE)'))], c('Temperature','Precipitation'))) %>%
  ungroup() %>%
  arrange(var, Stage, group, Predictor)

#check order
#as.data.frame(unique(paste(j$var, j$Stage,j$group)))

usepackage_latex("gensymb")

tableS2 <- j %>%
  filter(group != 'all' & stage %in% c('rain','bank')) %>%
  transmute(
    `Model/Variable` = Predictor,
    Coefficient = ifelse(pval < .05 & Predictor == 'Precipitation', format(round(Estimate, 5), nsmall = 5), format(round(Estimate, 2), nsmall = 2)),
    `Std. Error` = format(round(se, 2), nsmall = 2),
    `t-statistic` = format(round(tval, 3), nsmall = 3),
    `P-value` = format(round(pval, 3), nsmall = 3),
    `P-value` = cell_spec(`P-value`, format = 'latex', bold = as.numeric(`P-value`) < 0.05,
    italic = as.numeric(`P-value` > 0.05 & as.numeric(`P-value` < 0.1)))) %>%
  kable(format = 'latex', escape = F, booktabs = T, align = c('l','r','r','r','r')) %>%
  kable_styling() %>%
  group_rows("Seed rain seed density, locally transient species only", 1, 2) %>%
  group_rows("Percent locally transient seeds in the seed rain", 3, 4) %>%
  group_rows("Seed bank seed density, locally transient species only", 5, 6) %>%
  group_rows("Percent locally transient seeds in the seed bank", 7, 8) %>%
  group_rows("Seed rain richness, locally transient species only", 9, 10) %>%
  group_rows("Percent locally transient species in the seed rain", 11, 12) %>%
  group_rows("Seed bank richness, locally transient species only", 13, 14) %>%
  group_rows("Percent locally transient species in the seed bank", 15, 16) %>%
  row_spec(0, bold = T) %>%
  footnote(general_title = "Table S2.",
           general = "Summary statistics for multiple linear regression models of seed abundances and species richness of locally transient species across sites. Each set of rows (i.e., predictors) with a bold header is a model. In each model, a data point is a number of seeds or species at a site; N = 12. P-values are bold when < 0.05, and italic when < 0.1. Temperature refers to mean summer temperature (\\\\degree C), defined as the four warmest months of the year, and mean annual precipitation is in mm. Temperature and precipitation interaction terms were never significant and thus excluded (data not shown) .", threeparttable = T, escape = FALSE, title_format = "bold")


tableS3 <- j %>%
  filter(group == 'all') %>%
  filter(!(stage == 'mature' & var == 'abun')) %>%
  transmute(
    `Model/Variable` = Predictor,
    Coefficient = format(round(Estimate, 1), nsmall = 1),
    `Std. Error` = format(round(se, 1), nsmall = 1),
    `t-statistic` = format(round(tval, 3), nsmall = 3),
    `P-value` = format(round(pval, 3), nsmall = 3),
    `P-value` = cell_spec(`P-value`, format = 'latex', bold = as.numeric(`P-value`) < 0.05,
    italic = as.numeric(`P-value` > 0.05 & as.numeric(`P-value` < 0.1)))) %>%
  kable(format = 'latex', escape = F, booktabs = T, align = c('l','r','r','r','r')) %>%
  kable_styling() %>%
  group_rows("Seed rain seed density, all species", 1, 2) %>%
  group_rows("Seed bank seed density, all species", 3, 4) %>%
  group_rows("Emerged seedling density, all species", 5, 6) %>%
  group_rows("Established seedling density, all species", 7, 8) %>%
  group_rows("Seed rain richness, all species", 9, 10) %>%
  group_rows("Seed bank richness, all species", 11, 12) %>%
  group_rows("Emerged seedling richness, all species", 13, 14) %>%
  group_rows("Established seedling richness, all species", 15, 16) %>%
  group_rows("Adult vegetation richness, all species", 17, 18) %>%
  row_spec(0, bold = T) %>%
  footnote(general_title = "Table S3.",
           general = "Summary statistics for multiple linear regression models of total seed and seedling abundances, and total seed, seedling, and adult species richness across sites. Each set of rows (i.e., predictors) with a bold header is a model. In each model, a data point is a number of seeds, seedlings, percent cover units of adult vegetation, or species at a site; N = 12. P-values are bold when < 0.05, and italic when < 0.1. Temperature refers to mean summer temperature (\\\\degree C), defined during the three warmest months of the year, and mean annual precipitation (mm). Temperature and precipitation interaction terms were never significant and thus excluded (data not shown).", threeparttable = T, escape = FALSE, title_format = "bold")

kable_as_image(tableS2, filename = paste0(image_dir,'tabS2'), density = 500)

```

\pagebreak

```{r linear model stats table transients only}

tableS3

kable_as_image(tableS3, filename = paste0(image_dir,'tabS3'), density = 500)

```

\pagebreak


```{r individuals recorded table}

j <- rbind(x_origins, filter(xS_origins, stage == 'seed'))

j <- rbind(
  mutate(j, id = 'All individuals'),
  mutate(j),
  mutate(j, id = ifelse(idT == 'Unknown', 'Unknown temperature', idT)) %>% filter(id != 'Local'),
  mutate(j, id = ifelse(idP == 'Unknown', 'Unknown precipitation', idP)) %>% filter(id != 'Local')) %>%
  mutate(
    id = factor(id, levels = c('All individuals','Persistent','Transient','Same temperature','Cooler','Warmer','Unknown temperature','Same precipitation','Drier','Wetter','Unknown precipitation')),
    stage = stage_labels(stage)) %>%
  group_by(id, stage) %>%
  summarise(abun = round(sum(abun))) %>%
  group_by(stage) %>%
  mutate(percent = sprintf("%.1f", 100 * abun / abun[id == 'All individuals'], digits = 1)) %>%
  ungroup() %>%
  gather(var, val, abun, percent) %>%
  mutate(var = paste(stage, var, sep = "_"), stage = NULL) %>%
  spread(var, val, fill = 0)

j <- j[, c('id','Seed rain_abun','Seed rain_percent',
                'Seed bank_abun','Seed bank_percent',
                'All seeds_abun','All seeds_percent',
                'Emerged_abun','Emerged_percent',
                'Established_abun','Established_percent')]

colnames(j) <- c('Species status',rep(c('No.','%'), 5)) 
j$`Species status` <- as.character(j$`Species status`)
j$`Species status`[c(4,7,8,11)] <- c('Same', 'Unknown','Same','Unknown')

tmp <- kable(j, format = 'latex', escape = T, booktabs = T, align = c('l','r','r','r','r','r','r','r','r','r','r'), linesep = "") %>%
  kable_styling() %>%
  add_indent(c(2:11)) %>%
  #add_indent(c(4:11)) %>%
  group_rows("Temperature origins of locally transient species", 4, 7) %>%
  group_rows("Precipitation origins of locally transient species", 8, 11) %>%
  row_spec(0, bold = T) %>%
  add_header_above(c(" " = 1, "Seed rain" = 2, "Seed bank" = 2, "All seeds" = 2, "Emerged" = 2, "Established" = 2), bold = T) %>%
  footnote(general = "Numbers of individuals recorded, grouped by local transient/persistent species status and putative climate origins. Percentages are of all individuals (top row). Individuals that could not be identified to species were not included.", general_title = "Table S4.", threeparttable = T, title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabS4'), density = 500)

```

\pagebreak

```{r transients by cutoffs} 

j <- all_cutoffs %>%
  filter(stage == 'seed') %>%
  group_by(group, id) %>%
  summarise(spp = length(sp), abun = sum(abun)) %>%
  gather(var, val, spp, abun) %>%
  spread(group, val) %>%
  arrange(id,  desc(var)) %>%
  mutate(id = ifelse(id == 'Persistent',
                     ifelse(var == 'spp', 'Persistent populations', 'Seeds of persistent spp.'),
                     ifelse(var == 'spp', 'Transient populations', 'Seeds of transient spp.'))) %>%
  select(-var)

colnames(j) <- c(' ', '1+', '2+', '3+', '4')

tmp <- kable(j, format = 'latex', escape = T, booktabs = T, align = c('l','r','r','r','r'), linesep = "") %>%
  kable_styling() %>%
  row_spec(0, bold = T) %>%
  column_spec(2:5, width = "4em") %>%
  add_header_above(c(" " = 1, "No. of local occurrences required\nfor a pop. to be considered persistent" = 4), bold = T) %>%
  footnote(general = "Numbers of site-level transient/persistent populations, and the total numbers of seeds these populations represent, under each of four possible cutoff scenarios separating locally transient/persistent species in this study. Specifically, that locally persistent populations were only those which occurred in (1) one or more, (2) two or more, (3) three or more, or (4) all four of four total annual adult vegetation surveys. Values reflect the combined seed rain and seed bank.", general_title = "Table S6.", threeparttable = T, title_format = "bold")
  
kable_as_image(tmp, filename = paste0(image_dir,'tabS6'), density = 500)


```

```{r species site correlations}

# no generic sp's here
j <- x %>%
  mutate(
    den = abun / (4 * 0.25^2),
    stage = stage_labels(stage)) %>%
  select(-abun, -id) %>%
  spread(stage, den, fill = 0) %>%
  mutate(`All seeds` = `Seed rain` + `Seed bank`) %>%
  select(`Seed rain`, `Seed bank`, `All seeds`, Emerged, Established, `Mature vegetation`)

mycor <- cor(j)
j <- as.matrix(mycor)
j <- apply(j, 1, function(x) sprintf("%.2f", x))
row.names(j) <- colnames(j)
j[lower.tri(j, diag = T)] <- ''
j <- j[c(1:nrow(j)-1), c(2,4:ncol(j))]

tmp <- j %>%
  kable(format = 'latex', booktabs = T, align = c('r','r','r','r'))  %>%
  kable_styling() %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold = T) %>%
  footnote(general_title = "Table S5.", threeparttable = T, title_format = "bold",
           general = "Pearson correlations of species abundances across life stages, grouped by site (N = 805). Unidentified seeds and seedlings were not included.") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabS5'), density = 500)

```

\pagebreak

```{r seedling establishment model table}

j <- mod_coefs %>%
  filter(Model %in% c('estNull','estClim','estS','estP','estT')) %>%
  mutate(Variable = as.character(Variable)) %>%
  complete(Model, Variable) %>%
  mutate(Variable = factor(Variable, levels = myvars[-11])) %>%
  arrange(Model, Variable) %>%
  mutate(
    Estimate = sprintf("%.2f", Estimate),
    Estimate = ifelse(p.value < 0.001, paste0("**", Estimate),
                           ifelse(p.value < 0.05, paste0("*", Estimate), Estimate)),
    p.value = NULL) %>%
  spread(Model, Estimate, fill = NA) %>%
  mutate(
    Variable = as.character(Variable),
    N = c(rep(sum(est_n[c(1,2,4,5,8)]), 3), rep(sum(est_n[c(2,4,5,8)]),3), est_n[c(2,4,5,3,6,7,8)])) %>%
  select(Variable, estNull, estClim, estS, estT, estP)

AICs <- c('$\\Delta$AIC', sprintf("%.2f", c(c(AIC(estNull), AIC(estClim), AIC(estS), AIC(estT), AIC(estP)) - AIC(estNull))))

j <- rbind(AICs, j)

options(knitr.kable.NA = '-')

tmp <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", align = c('l','r','r','r','r','r','r'), col.names = linebreak(c("", "Null model", "Site climate", "Site climate +\nSp. status", "Site climate +\n Sp. temp. origin", "Site climate +\nSp. precip. origin"), align = 'r')) %>%
  kable_styling() %>%
  group_rows("General predictors", 2, 4) %>%
  group_rows("Transient/Persistent predictor", 5, 7) %>%
  group_rows("Origin-based predictors", 8, 14) %>%
  footnote(threeparttable = TRUE, general = 'Standardized coefficients (i.e., z-scores) from different GLM models (columns) predicting numbers of established seedlings by species and site. In column headers (i.e., model descriptions), "Species status" refers to whether the species has been labeled as locally transient or persistent, and "Species temperature/precipitation origin" refers to the putative climate origin based on the nearest adult population. Data include all recorded seedlings that could be identified to species. Asterisks denote significance (*: p < 0.05, **: p < 0.001). Dashes indicate predictors that were not included in a given model. Including model terms for transient/persistent species status and putative temperature and precipitation origins did not improve model performance, as reflected in the increase of AIC values relative to the null model based only on local numbers of emerged seedlings.', general_title = "Table S5.", title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabS5'), density = 500)

```


\pagebreak

```{r transition probabilities presence absence, fig.height = 3.5}

j <- xS %>%
  spread(stage, abun, fill = 0) %>%
  mutate(id = ifelse(id == 'Persistent', 'Locally persistent', 'Locally transient'))

#transform data to binomial 
# note that I add 1 to seed here because I eventually do that to plot. And if I want to predict loess curves in the final plot, I need to add 1 to seeds now.
tmp <- j %>% 
  mutate(germ = ifelse(germ > 0, 1, 0), 
         seed = seed + 1) %>%
  select(germ, seed, id)

tmp_tran <- tmp %>% 
  filter(id == 'Locally transient') %>%
  transmute(x = seed, y = germ)
tmp_tran <- predmod_log(tmp_tran$x, tmp_tran$y)
tmp_tran <- mutate(tmp_tran, seed = x, germ = y, id = 'Locally transient')

tmp_per <- tmp %>% 
  filter(id == 'Locally persistent') %>%
  transmute(x = seed, y = germ)
tmp_per <- predmod_log(tmp_per$x, tmp_per$y)
tmp_per <- mutate(tmp_per, seed = x, germ = y, id = 'Locally persistent') %>%
  filter(seed <= max(tmp_tran$seed))

#plot
p1 <- ggplot(filter(tmp, seed <= max(tmp_tran$seed)), aes(x=seed, y=germ, fill = id, color = id)) +
  geom_point(alpha = 0.1) + 
  geom_ribbon(data = tmp_per, aes(ymin = ymin, ymax = ymax), alpha = 0.5, color = NA) +
  geom_line(data = tmp_per, lwd = 1.15) +
  geom_ribbon(data = tmp_tran, aes(ymin = ymin, ymax = ymax), alpha = 0.5, color = NA) +
  geom_line(data = tmp_tran, lwd = 1.15) +
  scale_fill_manual(values = c('black','red')) +
  scale_color_manual(values = c('black','red')) +
  scale_y_continuous(breaks=c(0,1)) +
  scale_x_log10(breaks = c(1,10,100,1000)) +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    axis.title.y=element_text(vjust = 8),
    plot.margin = unit(c(5.5,5.5,5.5,21.5), "pt"),
    legend.title = element_blank(),
    legend.position = 'none') +
  labs(x = 'Seeds + 1', y = 'Species emergence probability')

# also want to predict loess curves for establishment
tmp <- j %>% 
  filter(germ > 0) %>%
  mutate(
    germ = germ + 1,
    est = ifelse(est > 0, 1, 0)) %>%
  select(germ, est, id)

tmp_tran <- tmp %>% 
  filter(id == 'Locally transient') %>%
  transmute(x = germ, y = est)
tmp_tran <- predmod_log(tmp_tran$x, tmp_tran$y)
tmp_tran <- mutate(tmp_tran, germ = x, est = y, id = 'Locally transient')

tmp_per <- tmp %>% 
  filter(id == 'Locally persistent') %>%
  transmute(x = germ, y = est)
tmp_per <- predmod_log(tmp_per$x, tmp_per$y)
tmp_per <- mutate(tmp_per, germ = x, est = y, id = 'Locally persistent') %>%
  filter(germ <= max(tmp_tran$germ))

# Plot
p2 <- tmp %>% 
  filter(germ <= max(tmp_tran$germ)) %>%
  ggplot(aes(x=germ, y=est, fill = id, color = id)) +
  geom_point(alpha = 0.1) + 
  geom_ribbon(data = tmp_per, aes(ymin = ymin, ymax = ymax), alpha = 0.5, color = NA) +
  geom_line(data = tmp_per, lwd = 1.15) +
  geom_ribbon(data = tmp_tran, aes(ymin = ymin, ymax = ymax), alpha = 0.5, color = NA) +
  geom_line(data = tmp_tran, lwd = 1.15) +
  scale_fill_manual(values = c('black','red')) +
  scale_color_manual(values = c('black','red')) +
  scale_y_continuous(breaks=c(0,1)) +
  scale_x_log10(breaks = c(2,10)) +
  theme_bw() +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank(),
    axis.title.y=element_text(vjust = 3.3),
    plot.margin = unit(c(5.5,5.5,5.5,10.5), "pt"),
    legend.position = 'none',
    legend.title = element_blank()) +
  labs(x = 'Emerged seedlings + 1', y = 'Species establishment probability')

p <- ggarrange(p1, p2, ncol=2, common.legend = TRUE, legend = 'bottom')

plot_it(p, name = 'emergeEstabBinary', dir = image_dir, width = 7, height = 3.5)


```


```{r species emergence model table}

j <- mod_coefs %>%
  filter(Model %in% c('germbinNull','germbinClim','germbinS','germbinP','germbinT')) %>%
  mutate(Variable = as.character(Variable)) %>%
  complete(Model, Variable) %>%
  mutate(Variable = factor(Variable, levels = myvars[-11])) %>%
  arrange(Model, Variable) %>%
  mutate(
    Estimate = sprintf("%.2f", Estimate),
    Estimate = ifelse(p.value < 0.001, paste0("**", Estimate),
                           ifelse(p.value < 0.05, paste0("*", Estimate), Estimate)),
    p.value = NULL) %>%
  spread(Model, Estimate, fill = NA) %>%
  mutate(
    Variable = as.character(Variable),
    N = c(rep(sum(germ_n[c(1,2,4,5,8)]), 3), rep(sum(germ_n[c(2,4,5,8)]), 3), germ_n[c(2,4,5,3,6,7,8)])) %>%
  select(Variable, germbinNull, germbinClim, germbinS, germbinT, germbinP)

AICs <- c('$\\Delta$AIC', sprintf("%.2f", c(c(AIC(germbinNull), AIC(germbinClim), AIC(germbinS), AIC(germbinT), AIC(germbinP)) - AIC(germbinNull))))

j <- rbind(AICs, j)

options(knitr.kable.NA = '-')

tmp <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", align = c('l','r','r','r','r','r','r'),
      col.names = linebreak(c("", "Null model", "Site climate", "Site climate +\nSp. status", "Site climate +\n Sp. temp. origin", "Site climate +\nSp. precip. origin"), align = 'r')) %>%
  kable_styling() %>%
  group_rows("General predictors", 2, 4) %>%
  group_rows("Transient/Persistent predictors", 5, 7) %>%
  group_rows("Origin-based predictors", 8, 14) %>%
  footnote(threeparttable = TRUE, general = 'Standardized coefficients (i.e., z-scores) from different GLM models (columns) predicting the presence/absence of emerged seedlings by species and site. In column headers (i.e., model descriptions), "Species status" refers to whether the species is locally transient or persistent, and "Species temperature/precipitation origin" refers to the putative climate origin based on the nearest persistent adult population. Data include all recorded seedlings that could be identified to species. Asterisks denote significance (*: p < 0.05, **: p < 0.001). Dashes indicate predictors that were not included in a given model. Including model terms for local transient/persistent species status and then putative temperature and precipitation origins improved model performance, as reflected in the reduction of AIC values relative to the null model using only local seed numbers as a predictor.', general_title = "Table A1-1.", title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabA1_1'), density = 500)

```


\pagebreak

```{r species establishment model table}

j <- mod_coefs %>%
  filter(Model %in% c('estbinNull','estbinClim','estbinS','estbinP','estbinT')) %>%
  mutate(Variable = as.character(Variable)) %>%
  complete(Model, Variable) %>%
  mutate(Variable = factor(Variable, levels = myvars[-11])) %>%
  arrange(Model, Variable) %>%
  mutate(
    Estimate = sprintf("%.2f", Estimate),
    Estimate = ifelse(p.value < 0.001, paste0("**", Estimate),
                           ifelse(p.value < 0.05, paste0("*", Estimate), Estimate)),
    p.value = NULL) %>%
  spread(Model, Estimate, fill = NA) %>%
  mutate(
    Variable = as.character(Variable),
    N = c(rep(sum(est_n[c(1,2,4,5,8)]), 3), rep(sum(est_n[c(2,4,5,8)]), 3), est_n[c(2,4,5,3,6,7,8)])) %>%
  select(Variable, estbinNull, estbinClim, estbinS, estbinT, estbinP)

AICs <- c('$\\Delta$AIC', sprintf("%.2f", c(c(AIC(estbinNull), AIC(estbinClim), AIC(estbinS), AIC(estbinT), AIC(estbinP)) - AIC(estbinNull))))

j <- rbind(AICs, j)

options(knitr.kable.NA = '-')

tmp <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", align = c('l','r','r','r','r','r','r'), col.names = linebreak(c("", "Null model", "Site climate", "Site climate +\nSp. status", "Site climate +\n Sp. temp. origin", "Site climate +\nSp. precip. origin"), align = 'r')) %>%
  kable_styling() %>%
  group_rows("General predictors", 2, 4) %>%
  group_rows("Transient/Persistent predictor", 5, 7) %>%
  group_rows("Origin-based predictors", 8, 12) %>%
  footnote(threeparttable = TRUE, general = 'Standardized coefficients (i.e., z-scores) from different GLM models (columns) predicting the presence/absence of established seedlings by species and site. In column headers (i.e., model descriptions), "Species status" refers to whether the species is locally transient or persistent, and "Species temperature/precipitation origin" refers to the putative climate origin based on the nearest adult population. Data include all recorded seedlings that could be identified to species. Asterisks denote significance (*: p < 0.05, **: p < 0.001). Dashes indicate predictors that were not included in a given model. Including model terms for transient/persistent species status and then putative temperature and precipitation origins did not improve model performance, as reflected in the increase of AIC values relative to the null model based only on local numbers of emerged seedlings.', general_title = "Table A1-2.", title_format = "bold") %>%
  landscape()

kable_as_image(tmp, filename = paste0(image_dir,'tabA1_2'), density = 500)

```

#APPENDIX B

List of species used in this study and their net abundances across stages. For adult plant data, the mean percent cover is calculated for each species at each site, and then summed over sites. Otherwise, abundance is the sum of all individuals collected or measured.


```{r Species List appendix}

# write a species list for supplementary materials?
shortlabs <- c('Rain' = 'rain', 'Bank' = 'bank', 'Emerged' = 'germ',
               'Established' = 'est', 'Adults' = 'mature')
j <- x %>%
  mutate(stage = factor(names(shortlabs)[match(stage, shortlabs)], levels = names(shortlabs))) %>%
  group_by(site, stage, sp) %>%
  summarise(abun = ceiling(abun)) %>%
  group_by(stage, sp) %>%
  summarise(abun = sum(abun)) %>%
  ungroup() %>%
  mutate(
    Species = dict$Species[match(sp, dict$Species.code)],
    `Code` = sp, sp = NULL) %>%
  spread(stage, abun, fill = 0)

#here, everything is raw abundances except for Adults, in which case it is the sum of the relative abundances of each species at all 12 sites.

A2 <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", longtable = TRUE) %>%
  kable_styling(latex_options = 'repeat_header') %>%
  row_spec(0, bold = T)

saveRDS(A2, paste0(wd,'MS_Transients\\images\\A2.RDS'))

A2

setwd(paste0(wd, "//MS_RecruitTag//figures"))
write.csv(j, file = 'SpeciesStageAbundances.csv', row.names = F)

```


# APPENDIX C

Species trait values used in this study. Trait values for taxonomically unresolved genera (e.g., *Pyrola sp*, *Epilobium sp*) are means based on field data. Trait abbreviations (i.e., column headers) are defined as follows: LA: leaf area (mm^2^); MH: maximum height (m); SM: seed mass (mg); SLA: specific leaf area (m^2^/kg); CP: persistence of plant-offspring connections (0: fewer than two years; 1: two or more years); CO: number of offspring per parent per year (0: one or fewer offspring; 1: two or more offspring); LAT: rate of lateral spread (0: one cm/year; 1: more than one cm/year; BUDS: number of buds per ramet (an integer score ranging from one (few buds belowground and aboveground) to eight (many buds belowground and aboveground)). LA, MH, SM, and SLA values are log10-transformed.

```{r Species traits appendix}


j <- trait.data %>%
  dplyr::select(Species = sp, LA = leaf.area, MH = max.height, SM = 'seed.mass', SLA = sla, CP = conper, CO = offs, LAT = lat, BUDS = buds) %>%
  mutate(Species = dict$Species[match(Species, dict$Species.code)]) %>%
  mutate_if(is.numeric, round, 2) %>%
  arrange(Species)

options(knitr.kable.NA = '-')

A3 <- kable(j, format = 'latex', escape = F, booktabs = T, linesep = "", longtable = TRUE) %>%
  kable_styling(latex_options = 'repeat_header') %>%
  row_spec(0, bold = T)

saveRDS(A3, paste0(wd,'MS_Transients\\images\\A3.RDS'))

A3

#setwd(paste0(wd, "//MS_RecruitTag//figures"))
#write.csv(j, file = 'SpeciesTraitData.csv', row.names = F)

```


```{r various stats for Results, include = FALSE}

"Transient seeds occurred at all 12 grassland sites"
x %>% filter(id == 'Transient') %>% summarise(sites = length(unique(site)))


"Although seeds of transient species comprised ~10% of the combined seed rain and seed bank communities"
x %>%
  filter(stage %in% c('rain','bank')) %>%
  group_by(id) %>%
  summarise(abun = sum(abun)) %>%
  spread(id, abun, fill = 0) %>%
  mutate(Percent_transient = Transient/(Transient + Persistent))
  

"Transient seeds in the combined seed rain and seed bank contributed 189 locally-novel species across all sites."
x %>% 
  filter(id == 'Transient' & stage %in% c('rain','bank')) %>% 
  group_by(site) %>% 
  summarise(n = length(unique(paste(site, sp)))) %>% ungroup() %>% summarise(n = sum(n))

"How many seeds disperse from warmer to cooler sites?"
paste(round(100 * sum(xS_origins$abun[xS_origins$stage == 'seed' & xS_origins$idT == 'Warmer']) / 
  sum(xS_origins$abun[xS_origins$stage == 'seed']), 1), '%') 

"How many species disperse from warmer to cooler sites?"
paste(length(unique(xS_origins$sp[xS_origins$stage == 'seed' & xS_origins$idT == 'Warmer'])), '/', length(unique(xS_origins$sp[xS_origins$stage == 'seed'])), 'or', round(100 * length(unique(xS_origins$sp[xS_origins$stage == 'seed' & xS_origins$idT == 'Warmer'])) / length(unique(xS_origins$sp[xS_origins$stage == 'seed'])), 1), '%') 

"How many species disperse from wetter to drier sites?"
paste(length(unique(xS_origins$sp[xS_origins$stage == 'seed' & xS_origins$idP == 'Wetter'])), '/', length(unique(xS_origins$sp[xS_origins$stage == 'seed'])), 'or', round(100 * length(unique(xS_origins$sp[xS_origins$stage == 'seed' & xS_origins$idP == 'Wetter'])) / length(unique(xS_origins$sp[xS_origins$stage == 'seed'])), 1), '%') 


"How many seedlings did we record (including unidentified seedlings)? How many established?"
sum(x_sp$abun[x_sp$stage == 'germ'])
sum(x_sp$abun[x_sp$stage == 'est'])

"How many adult species were persistent? i.e., persistent adult richness?"
x %>% filter(stage == 'mature' & id == 'Persistent') %>% summarise(adult_rich = length(unique(sp)))

"How many adults were never seen as seeds or seedlings outside of thier local sites"
sum(!unique(x$sp[x$stage == 'mature' & x$id == 'Persistent']) %in% xS$sp[xS$stage %in% c('seed','seedling') & xS$id == 'Transient'])

"How many persistent adult species had no seed or seedlings observed anywhere"
sum(!unique(x$sp[x$stage == 'mature' & x$id == 'Persistent']) %in% xS$sp[xS$stage %in% c('seed','germ')])

"What were those species?"
unique(x$sp[x$stage == 'mature' & x$id == 'Persistent'])[!unique(x$sp[x$stage == 'mature' & x$id == 'Persistent']) %in% xS$sp[xS$stage %in% c('seed','germ')]]

"At how many sites did transient species emerge?" 
x %>% filter(id == 'Transient' & stage == 'germ') %>% group_by(site, stage) %>% summarise(abun = sum(abun), rich = length(unique(sp))) %>% ungroup() %>% mutate(all_trans = sum(abun), all_sp = sum(rich), all = sum(x$abun[x$stage == 'germ']), per = all_trans/all) %>% filter(abun > 0) %>% nrow()

"At how many sites did transient species establish?"
"How many transient species established at sites?"
x %>% filter(id == 'Transient' & stage == 'est') %>% group_by(site, stage) %>% summarise(abun = sum(abun), rich = length(unique(sp))) %>% ungroup() %>% mutate(all_trans = sum(abun), all_sp = sum(rich), all = sum(x$abun[x$stage == 'est']), per = all_trans/all) %>% filter(abun > 0) %>% mutate(total_sites = length(all))

"how many species dispersed into cooler/wetter sites"
xS_origins %>%
  filter(stage == 'seed') %>%
  group_by(idT) %>%
  summarise(abun = sum(abun), rich = length(unique(sp))) %>%
  ungroup() %>%
  mutate(percentage = abun / sum(abun))
xS_origins %>%
  filter(stage == 'seed') %>%
  group_by(idP) %>%
  summarise(abun = sum(abun), rich = length(unique(sp))) %>%
  ungroup() %>%
  mutate(percentage = abun / sum(abun))

# Transition probabilities, NOT GROUPED BY SPECIES.
xS_sp %>%
  filter(stage != 'mature') %>%
  group_by(site, stage) %>%
  mutate(den = abun / (4 * 0.25^2)) %>%
  summarise(den = sum(den)) %>%
  spread(stage, den, fill = 0) %>%
  ungroup() %>%
  summarise(
    Emergence = paste(sprintf("%.2f", mean(germ/seed)), "±", 
                      sprintf("%.2f", sd(germ/seed))),
    Establishment = paste(sprintf("%.2f", mean(est/germ)), "±", 
                          sprintf("%.2f", sd(est/germ))),
    `Seed-to-Establishment` = paste(sprintf("%.2f", mean(est/seed)), "±", 
                                    sprintf("%.2f", sd(est/seed)))) %>%
  gather(Transition, `Rate`, Emergence, Establishment, `Seed-to-Establishment`)


### how does richness in the bank vs rain compare when subsampling to equal depths
if(FALSE) {
  tmp <- x %>%
    filter(stage %in% c('rain','bank')) %>%
    group_by(stage, site, sp) %>%
    summarise(abun = ceiling(sum(abun))) %>%
    group_by(site) %>%
    mutate(n = min(sum(abun[stage == 'rain']), sum(abun[stage == 'bank'])))
  
  tmp2 <- list()
  for(i in unique(tmp$site)) {
    for(j in unique(tmp$stage)) {
      tmp3 <- filter(tmp, site == i & stage == j)
      tmp2[[paste0(j,i)]] <- table(sample(rep(tmp3$sp, times = tmp3$abun), 
                                   size = tmp3$n[[1]], replace = FALSE))
    }
  }
  tmp <- reshape2::melt(tmp2) %>%
    separate(L1, sep = 4, into = c('stage','site')) %>%
    transmute(site, stage, sp = Var1, abun = value) %>%
    group_by(site) %>%
    mutate(n = sum(abun)) %>%
    bind_rows(tmp) %>%
    group_by(site, stage) %>%
    summarise(rich = length(unique(sp[abun > 0]))) %>%
    spread(stage, rich) %>%
    left_join(site.meta, by = 'site') %>%
    mutate(
    MST = factor(c(6,9,10.5)[match(temp.level, c(1:3))], levels = c(6,9,10.5)),
    MAP = factor(c(650,1300,2000,2900)[match(precip.level, c(1:4))], levels = c(650,1300,2000,2900)))
  
    ggplot(tmp, aes(x = rain, y = bank)) +
      geom_point(aes(fill = MAP, shape = MST), size = 3) +
      geom_point(aes(x = bank, y = rain), alpha = 0) +
      geom_abline(slope = 1, lty = 3) +
      scale_fill_manual(values = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F'), name = '') +
      scale_shape_manual(values = c(24,21,25), 'Mean annual precipitation') +
      labs(x = 'Seed rain richness (subsampled)', y = 'Seed bank richness (subsampled)') +
      th +
      guides(fill = guide_legend(override.aes = list(shape = 21, fill = c('#87CEEB', '#749ED5', '#5057B2', '#140D8F'))))

    #summary stats, in terms of number of species
    summarise(ungroup(tmp), mean = mean(bank - rain), mean_percent = mean(bank / rain), sd = sd(bank - rain))
    
}

#trait-based differences over life stages...
xS_origins %>% filter(stage != 'mature') %>% left_join(trait.data, by = 'sp') %>% gather(trait, val, leaf.area, max.height, seed.mass, sla, conper, offs, lat, buds) %>% select(-id, -idP) %>% group_by(site, stage, idT, trait) %>% summarise(cm = mean(val, na.rm = T)) %>% ungroup() %>% mutate(stage = factor(stage, levels = c('seed','germ','est'))) %>% ggplot(aes(x = stage, y = cm, color = idT)) + geom_boxplot(outlier.shape = NA) + facet_wrap(~trait, scales = 'free')



```

